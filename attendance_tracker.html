<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de Ausencias de Personal</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2em;
            margin-bottom: 10px;
        }
        
        .content {
            padding: 30px;
        }
        
        .section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }
        
        .section h2 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.3em;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            color: #333;
            font-weight: 500;
        }
        
        input[type="text"],
        input[type="date"],
        select {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        
        input[type="text"]:focus,
        input[type="date"]:focus,
        select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-success:hover {
            background: #218838;
        }
        
        .btn-info {
            background: #17a2b8;
            color: white;
        }
        
        .btn-info:hover {
            background: #138496;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
            padding: 8px 16px;
            font-size: 12px;
        }
        
        .btn-danger:hover {
            background: #c82333;
        }
        
        .btn-warning {
            background: #ffc107;
            color: #333;
            padding: 8px 16px;
            font-size: 12px;
        }
        
        .btn-warning:hover {
            background: #e0a800;
        }
        
        .file-input {
            display: none;
        }
        
        .file-label {
            display: inline-block;
            padding: 12px 24px;
            background: #28a745;
            color: white;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            margin-right: 10px;
        }
        
        .file-label:hover {
            background: #218838;
            transform: translateY(-2px);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        th {
            background: #667eea;
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
        }
        
        td {
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
        }
        
        tr:hover {
            background: #f8f9fa;
        }
        
        .actions {
            display: flex;
            gap: 5px;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
        }
        
        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 3px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .badge-success {
            background: #d4edda;
            color: #155724;
        }
        
        .badge-warning {
            background: #fff3cd;
            color: #856404;
        }
        
        .filter-section {
            display: flex;
            gap: 15px;
            align-items: end;
            flex-wrap: wrap;
        }
        
        .filter-group {
            flex: 1;
            min-width: 200px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìã Gestor de Ausencias de Personal</h1>
            <p>Control de ausencias y generaci√≥n de partes mensuales</p>
        </div>
        
        <div class="content">
            <!-- Secci√≥n de carga de personal -->
            <div class="section">
                <h2>üë• Gesti√≥n de Personal</h2>
                <label for="filePersonal" class="file-label">üìÅ Cargar Lista de Personal (CSV)</label>
                <input type="file" id="filePersonal" class="file-input" accept=".csv">
                <span id="personalStatus"></span>
            </div>
            
            <!-- Formulario de registro de ausencias -->
            <div class="section">
                <h2>‚ûï Registrar Ausencia</h2>
                <form id="absenceForm">
                    <div class="form-group">
                        <label for="personSelect">Persona:</label>
                        <select id="personSelect" required>
                            <option value="">Seleccione una persona</option>
                        </select>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div class="form-group">
                            <label for="startDate">Fecha de Inicio:</label>
                            <input type="date" id="startDate" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="endDate">Fecha de Fin:</label>
                            <input type="date" id="endDate" required>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div class="form-group">
                            <div class="checkbox-group">
                                <input type="checkbox" id="partTime">
                                <label for="partTime" style="margin: 0;">Tiempo parcial</label>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <div class="checkbox-group">
                                <input type="checkbox" id="justified">
                                <label for="justified" style="margin: 0;">Justificaci√≥n entregada</label>
                            </div>
                        </div>
                    </div>
                    
                    <button type="submit" class="btn btn-primary" id="submitBtn">‚úÖ Registrar Ausencia</button>
                    <button type="button" class="btn btn-warning" id="cancelBtn" style="display: none;">‚ùå Cancelar</button>
                </form>
            </div>
            
            <!-- Filtros y generaci√≥n de reportes -->
            <div class="section">
                <h2>üìä Filtros y Reportes</h2>
                <div class="filter-section">
                    <div class="filter-group">
                        <label for="filterMonth">Mes:</label>
                        <input type="month" id="filterMonth">
                    </div>
                    <div>
                        <button class="btn btn-info" onclick="generateMonthlyPDF()">üìÑ Generar PDF Mensual</button>
                    </div>
                </div>
                <div style="margin-top: 15px;">
                    <button class="btn btn-success" onclick="exportToCSV()">üíæ Exportar a CSV</button>
                    <button class="btn btn-success" onclick="exportToExcel()">üìä Exportar a Excel</button>
                    <label for="fileImport" class="file-label">üì• Importar Datos</label>
                    <input type="file" id="fileImport" class="file-input" accept=".csv,.xlsx" onchange="importData(event)">
                </div>
            </div>
            
            <!-- Lista de ausencias -->
            <div class="section">
                <h2>üìù Registro de Ausencias</h2>
                <div id="absenceList"></div>
            </div>
        </div>
    </div>

    <script>
        let db;
        let editingId = null;
        
        // Inicializar IndexedDB
        function initDB() {
            const request = indexedDB.open('AttendanceDB', 1);
            
            request.onerror = () => console.error('Error al abrir la base de datos');
            
            request.onsuccess = (e) => {
                db = e.target.result;
                loadPersonnel();
                loadAbsences();
            };
            
            request.onupgradeneeded = (e) => {
                db = e.target.result;
                
                if (!db.objectStoreNames.contains('personnel')) {
                    db.createObjectStore('personnel', { keyPath: 'id', autoIncrement: true });
                }
                
                if (!db.objectStoreNames.contains('absences')) {
                    const store = db.createObjectStore('absences', { keyPath: 'id', autoIncrement: true });
                    store.createIndex('person', 'person', { unique: false });
                    store.createIndex('startDate', 'startDate', { unique: false });
                }
            };
        }
        
        // Cargar personal desde CSV
        document.getElementById('filePersonal').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (event) => {
                const text = event.target.result;
                const lines = text.split('\n').filter(line => line.trim());
                
                const transaction = db.transaction(['personnel'], 'readwrite');
                const store = transaction.objectStore('personnel');
                
                // Limpiar personal existente
                store.clear();
                
                lines.forEach(line => {
                    const name = line.trim().replace(/["\r]/g, '');
                    if (name) {
                        store.add({ name: name });
                    }
                });
                
                transaction.oncomplete = () => {
                    loadPersonnel();
                    document.getElementById('personalStatus').textContent = `‚úÖ ${lines.length} personas cargadas`;
                    document.getElementById('personalStatus').style.color = '#28a745';
                };
            };
            reader.readAsText(file);
        });
        
        // Cargar personal en el select
        function loadPersonnel() {
            const transaction = db.transaction(['personnel'], 'readonly');
            const store = transaction.objectStore('personnel');
            const request = store.getAll();
            
            request.onsuccess = () => {
                const select = document.getElementById('personSelect');
                select.innerHTML = '<option value="">Seleccione una persona</option>';
                
                request.result.forEach(person => {
                    const option = document.createElement('option');
                    option.value = person.name;
                    option.textContent = person.name;
                    select.appendChild(option);
                });
            };
        }
        
        // Registrar ausencia
        document.getElementById('absenceForm').addEventListener('submit', (e) => {
            e.preventDefault();
            
            const absence = {
                person: document.getElementById('personSelect').value,
                startDate: document.getElementById('startDate').value,
                endDate: document.getElementById('endDate').value,
                partTime: document.getElementById('partTime').checked,
                justified: document.getElementById('justified').checked
            };
            
            const transaction = db.transaction(['absences'], 'readwrite');
            const store = transaction.objectStore('absences');
            
            if (editingId) {
                absence.id = editingId;
                store.put(absence);
                editingId = null;
                document.getElementById('submitBtn').textContent = '‚úÖ Registrar Ausencia';
                document.getElementById('cancelBtn').style.display = 'none';
            } else {
                store.add(absence);
            }
            
            transaction.oncomplete = () => {
                loadAbsences();
                document.getElementById('absenceForm').reset();
            };
        });
        
        // Cancelar edici√≥n
        document.getElementById('cancelBtn').addEventListener('click', () => {
            editingId = null;
            document.getElementById('absenceForm').reset();
            document.getElementById('submitBtn').textContent = '‚úÖ Registrar Ausencia';
            document.getElementById('cancelBtn').style.display = 'none';
        });
        
        // Cargar ausencias
        function loadAbsences() {
            const transaction = db.transaction(['absences'], 'readonly');
            const store = transaction.objectStore('absences');
            const request = store.getAll();
            
            request.onsuccess = () => {
                displayAbsences(request.result);
            };
        }
        
        // Mostrar ausencias
        function displayAbsences(absences) {
            const container = document.getElementById('absenceList');
            
            if (absences.length === 0) {
                container.innerHTML = '<div class="empty-state">No hay ausencias registradas</div>';
                return;
            }
            
            absences.sort((a, b) => new Date(b.startDate) - new Date(a.startDate));
            
            let html = `
                <table>
                    <thead>
                        <tr>
                            <th>Persona</th>
                            <th>Fecha Inicio</th>
                            <th>Fecha Fin</th>
                            <th>Tipo</th>
                            <th>Justificaci√≥n</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            absences.forEach(absence => {
                html += `
                    <tr>
                        <td><strong>${absence.person}</strong></td>
                        <td>${formatDate(absence.startDate)}</td>
                        <td>${formatDate(absence.endDate)}</td>
                        <td>${absence.partTime ? '<span class="badge badge-warning">Tiempo Parcial</span>' : '<span class="badge badge-success">Completa</span>'}</td>
                        <td>${absence.justified ? '‚úÖ S√≠' : '‚ùå No'}</td>
                        <td class="actions">
                            <button class="btn btn-warning" onclick="editAbsence(${absence.id})">‚úèÔ∏è</button>
                            <button class="btn btn-danger" onclick="deleteAbsence(${absence.id})">üóëÔ∏è</button>
                        </td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            container.innerHTML = html;
        }
        
        // Editar ausencia
        function editAbsence(id) {
            const transaction = db.transaction(['absences'], 'readonly');
            const store = transaction.objectStore('absences');
            const request = store.get(id);
            
            request.onsuccess = () => {
                const absence = request.result;
                document.getElementById('personSelect').value = absence.person;
                document.getElementById('startDate').value = absence.startDate;
                document.getElementById('endDate').value = absence.endDate;
                document.getElementById('partTime').checked = absence.partTime;
                document.getElementById('justified').checked = absence.justified;
                
                editingId = id;
                document.getElementById('submitBtn').textContent = 'üíæ Actualizar Ausencia';
                document.getElementById('cancelBtn').style.display = 'inline-block';
                
                window.scrollTo({ top: 0, behavior: 'smooth' });
            };
        }
        
        // Eliminar ausencia
        function deleteAbsence(id) {
            if (!confirm('¬øEst√° seguro de eliminar esta ausencia?')) return;
            
            const transaction = db.transaction(['absences'], 'readwrite');
            const store = transaction.objectStore('absences');
            store.delete(id);
            
            transaction.oncomplete = () => loadAbsences();
        }
        
        // Formatear fecha
        function formatDate(dateStr) {
            const date = new Date(dateStr + 'T00:00:00');
            return date.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric' });
        }
        
        // Generar PDF mensual
        function generateMonthlyPDF() {
            const monthInput = document.getElementById('filterMonth').value;
            if (!monthInput) {
                alert('Por favor, seleccione un mes');
                return;
            }
            
            const [year, month] = monthInput.split('-');
            
            const transaction = db.transaction(['absences'], 'readonly');
            const store = transaction.objectStore('absences');
            const request = store.getAll();
            
            request.onsuccess = () => {
                const absences = request.result.filter(absence => {
                    const startDate = new Date(absence.startDate);
                    return startDate.getFullYear() == year && (startDate.getMonth() + 1) == parseInt(month);
                });
                
                if (absences.length === 0) {
                    alert('No hay ausencias para el mes seleccionado');
                    return;
                }
                
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                doc.setFontSize(18);
                doc.text(`Parte de Ausencias - ${month}/${year}`, 14, 20);
                
                doc.setFontSize(10);
                doc.text(`Generado: ${new Date().toLocaleDateString('es-ES')}`, 14, 28);
                
                const tableData = absences.map(absence => [
                    absence.person,
                    formatDate(absence.startDate),
                    formatDate(absence.endDate),
                    absence.partTime ? 'Parcial' : 'Completa',
                    absence.justified ? 'S√≠' : 'No'
                ]);
                
                doc.autoTable({
                    startY: 35,
                    head: [['Persona', 'Fecha Inicio', 'Fecha Fin', 'Tipo', 'Justificada']],
                    body: tableData,
                    theme: 'grid',
                    headStyles: { fillColor: [102, 126, 234] },
                    styles: { fontSize: 9 }
                });
                
                doc.save(`ausencias_${month}_${year}.pdf`);
            };
        }
        
        // Exportar a CSV
        function exportToCSV() {
            const transaction = db.transaction(['absences'], 'readonly');
            const store = transaction.objectStore('absences');
            const request = store.getAll();
            
            request.onsuccess = () => {
                let csv = 'Persona,Fecha Inicio,Fecha Fin,Tiempo Parcial,Justificada\n';
                
                request.result.forEach(absence => {
                    csv += `"${absence.person}","${absence.startDate}","${absence.endDate}","${absence.partTime}","${absence.justified}"\n`;
                });
                
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `ausencias_${new Date().toISOString().split('T')[0]}.csv`;
                a.click();
            };
        }
        
        // Exportar a Excel
        function exportToExcel() {
            const transaction = db.transaction(['absences'], 'readonly');
            const store = transaction.objectStore('absences');
            const request = store.getAll();
            
            request.onsuccess = () => {
                const data = request.result.map(absence => ({
                    'Persona': absence.person,
                    'Fecha Inicio': absence.startDate,
                    'Fecha Fin': absence.endDate,
                    'Tiempo Parcial': absence.partTime ? 'S√≠' : 'No',
                    'Justificada': absence.justified ? 'S√≠' : 'No'
                }));
                
                const ws = XLSX.utils.json_to_sheet(data);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'Ausencias');
                XLSX.writeFile(wb, `ausencias_${new Date().toISOString().split('T')[0]}.xlsx`);
            };
        }
        
        // Importar datos
        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            
            reader.onload = (e) => {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                
                const transaction = db.transaction(['absences'], 'readwrite');
                const store = transaction.objectStore('absences');
                
                jsonData.forEach(row => {
                    const absence = {
                        person: row.Persona || row.person,
                        startDate: row['Fecha Inicio'] || row.startDate,
                        endDate: row['Fecha Fin'] || row.endDate,
                        partTime: (row['Tiempo Parcial'] || row.partTime) === 'S√≠' || (row['Tiempo Parcial'] || row.partTime) === true,
                        justified: (row.Justificada || row.justified) === 'S√≠' || (row.Justificada || row.justified) === true
                    };
                    store.add(absence);
                });
                
                transaction.oncomplete = () => {
                    loadAbsences();
                    alert('Datos importados correctamente');
                };
            };
            
            reader.readAsArrayBuffer(file);
        }
        
        // Establecer mes actual en el filtro
        const today = new Date();
        document.getElementById('filterMonth').value = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}`;
        
        // Inicializar la aplicaci√≥n
        initDB();
    </script>
</body>
</html>