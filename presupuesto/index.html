<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Presupuesto centros – local</title>
  <style>
    body { font-family: system-ui, sans-serif; margin: 1rem 2rem; }
    h1 { margin-bottom: 0.2rem; }
    table { border-collapse: collapse; width: 100%; margin-bottom: 1rem; }
    th, td { border: 1px solid #ccc; padding: 4px 6px; font-size: 0.9rem; }
    th { background: #f0f0f0; }
    input[type="number"] { width: 100%; box-sizing: border-box; }
    .section { border: 1px solid #aaa; padding: 0.5rem; margin-bottom: 1rem; }
    .section-header { display: flex; justify-content: space-between; align-items: center; gap: 1rem; }
    .error { color: #b00020; font-size: 0.85rem; }
    .ok { color: #006400; font-size: 0.85rem; }
    .controls { display: flex; gap: 0.5rem; flex-wrap: wrap; margin: 0.5rem 0 1rem; }
    button { cursor: pointer; }
  </style>
  <!-- jsPDF desde CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"
          crossorigin="anonymous" referrerpolicy="no-referrer"></script>
</head>
<body>
<h1>Presupuesto del centro</h1>
<p>Trabajo en local con guardado automático (IndexedDB), exportación/importación CSV y generación de PDF.</p>

<div class="controls">
  <label>
    <strong>Modo de entrada:</strong>
    <select id="modoEntrada">
      <option value="cantidades">Cantidades → calcular %</option>
      <option value="porcentajes">% → calcular cantidades</option>
    </select>
  </label>

  <button id="btnExportCSV">Exportar CSV</button>
  <input type="file" id="fileImportCSV" accept=".csv" />
  <button id="btnGenerarPDF">Generar PDF</button>
  <span id="estadoGuardado"></span>
</div>

<div id="contenedorSecciones"></div>

<script>
/* =========================
   1. Definición de partidas
   ========================= */

const SECCIONES = [
  {
    ingreso: { codigo: "101", nombre: "Créditos de la Consejería Educación para gastos de funcionamiento" },
    gastos: [
      { codigo: "2120", nombre: "Reparación y conservación edificios y otras construcciones" },
      { codigo: "2130", nombre: "Reparación y conservación maquinaria, instalaciones, utillaje" },
      { codigo: "2140", nombre: "Reparación y conservación de elementos de transporte" },
      { codigo: "2150", nombre: "Reparación y conservación de mobiliario y enseres" },
      { codigo: "2160", nombre: "Reparación y conservación equip. procesos de la información" },
      { codigo: "2200", nombre: "Material oficina, informático, libros, prensa, otras public." },
      { codigo: "2210", nombre: "Suministros: energía eléctrica" },
      { codigo: "2211", nombre: "Suministros: agua" },
      { codigo: "2213", nombre: "Suministros: combustibles" },
      { codigo: "2214", nombre: "Suministros: vestuario" },
      { codigo: "2215", nombre: "Suministros: productos alimenticios" },
      { codigo: "2217", nombre: "Materias primas para el funcionamiento de los servicios" },
      { codigo: "2218", nombre: "Suministros: mobiliario y equipamiento" },
      { codigo: "2219", nombre: "Otros suministros" },
      { codigo: "2220", nombre: "Comunicaciones: teléfono, télex, fax, serv. postal/telegráfico" },
      { codigo: "2230", nombre: "Transporte" },
      { codigo: "2240", nombre: "Primas de seguros" },
      { codigo: "2250", nombre: "Impuestos, tasas y contribuciones especiales" },
      { codigo: "2267", nombre: "Pago retenciones IRPF a Hacienda" },
      { codigo: "2268", nombre: "Gastos diversos: promoción económica, cultural y educativa" },
      { codigo: "2270", nombre: "Trabajos realizados por empresas de limpieza y aseo" },
      { codigo: "2271", nombre: "Trabajos realizados por empresas de seguridad" },
      { codigo: "2279", nombre: "Otros trabajos realizados por empresas y profesionales" },
      { codigo: "2400", nombre: "Otros gastos de funcionamiento" },
      { codigo: "2909", nombre: "Comisiones bancarias" }
    ]
  },
  {
    ingreso: { codigo: "1021", nombre: "Créditos de la C. Educación por subvenciones distintos al 2900-" },
    gastos: [
      { codigo: "2269", nombre: "Gastos distintos al funcionamiento operativo del centro" }
    ]
  },
  {
    ingreso: { codigo: "1021B", nombre: "Créditos de la C. Educación por subvenciones (libros texto y material didáctico)" },
    gastos: [
      { codigo: "2205", nombre: "C. Madrid: ayudas libros texto y material didáctico complementario" }
    ]
  },
  {
    ingreso: { codigo: "1024", nombre: "Créditos que provienen de Instituciones de la Unión Europea" },
    gastos: [
      { codigo: "2602", nombre: "Gastos corrientes financiados por la Unión Europea" }
    ]
  },
  {
    ingreso: { codigo: "1038", nombre: "Cualquier otro ingreso con autorización" },
    gastos: [
      { codigo: "2120", nombre: "Reparación y conservación edificios y otras construcciones" },
      { codigo: "2130", nombre: "Reparación y conservación maquinaria, instalaciones, utillaje" },
      { codigo: "2140", nombre: "Reparación y conservación de elementos de transporte" },
      { codigo: "2150", nombre: "Reparación y conservación de mobiliario y enseres" },
      { codigo: "2160", nombre: "Reparación y conservación equip. procesos de la información" },
      { codigo: "2219", nombre: "Otros suministros" },
      { codigo: "2220", nombre: "Comunicaciones: teléfono, télex, fax, serv. postal/telegráfico" },
      { codigo: "2230", nombre: "Transporte" },
      { codigo: "2240", nombre: "Primas de seguros" },
      { codigo: "2250", nombre: "Impuestos, tasas y contribuciones especiales" },
      { codigo: "2267", nombre: "Pago retenciones IRPF a Hacienda" },
      { codigo: "2268", nombre: "Gastos diversos: promoción económica, cultural y educativa" },
      { codigo: "2400", nombre: "Otros gastos de funcionamiento" },
      { codigo: "2909", nombre: "Comisiones bancarias" }
    ]
  },
  {
    ingreso: { codigo: "1041", nombre: "Cobro de la cuota del Seguro Escolar de los alumnos" },
    gastos: [
      { codigo: "9999", nombre: "Seguro Escolar: pago a la Tesorería Gral. Seguridad Social" }
    ]
  },
  {
    ingreso: { codigo: "1042", nombre: "Colaboración con la TGSS en la gestión del cobro Seguro Escolar" },
    gastos: [
      { codigo: "2200", nombre: "Material oficina, informático, libros, prensa, otras public." }
    ]
  }
];

/* =========================
   2. IndexedDB – almacenamiento
   ========================= */

const DB_NAME = "presupuesto-centro";
const DB_VERSION = 1;
const STORE_NAME = "datos";

let db = null;

function abrirDB() {
  return new Promise((resolve, reject) => {
    const request = indexedDB.open(DB_NAME, DB_VERSION);
    request.onupgradeneeded = (event) => {
      const db = event.target.result;
      if (!db.objectStoreNames.contains(STORE_NAME)) {
        db.createObjectStore(STORE_NAME, { keyPath: "id" });
      }
    };
    request.onsuccess = (event) => {
      db = event.target.result;
      resolve(db);
    };
    request.onerror = (event) => reject(event.target.error);
  });
}

function guardarEstadoIndexedDB(estado) {
  if (!db) return;
  const tx = db.transaction(STORE_NAME, "readwrite");
  const store = tx.objectStore(STORE_NAME);
  store.put({ id: "estado", data: estado });
  tx.oncomplete = () => {
    const el = document.getElementById("estadoGuardado");
    if (el) {
      el.textContent = "Guardado";
      setTimeout(() => el.textContent = "", 1500);
    }
  };
}

function cargarEstadoIndexedDB() {
  return new Promise((resolve, reject) => {
    if (!db) { resolve(null); return; }
    const tx = db.transaction(STORE_NAME, "readonly");
    const store = tx.objectStore(STORE_NAME);
    const req = store.get("estado");
    req.onsuccess = () => {
      resolve(req.result ? req.result.data : null);
    };
    req.onerror = (e) => reject(e.target.error);
  });
}

/* =========================
   3. Estado en memoria
   ========================= */

let estado = {}; 
// estructura: { [codigoIngreso]: { inicial, presupuestado, gastos: { [codigoGasto]: { cantidad, porcentaje } } } }

function crearEstadoInicial() {
  const obj = {};
  for (const sec of SECCIONES) {
    obj[sec.ingreso.codigo] = {
      inicial: 0,
      presupuestado: 0,
      gastos: {}
    };
    for (const g of sec.gastos) {
      obj[sec.ingreso.codigo].gastos[g.codigo] = {
        cantidad: 0,
        porcentaje: 0
      };
    }
  }
  return obj;
}

/* =========================
   4. Renderizado de la UI
   ========================= */

function render() {
  const cont = document.getElementById("contenedorSecciones");
  cont.innerHTML = "";
  const modo = document.getElementById("modoEntrada").value;

  SECCIONES.forEach(sec => {
    const ingresoCodigo = sec.ingreso.codigo;
    const data = estado[ingresoCodigo];

    const div = document.createElement("div");
    div.className = "section";

    const header = document.createElement("div");
    header.className = "section-header";
    header.innerHTML = `
      <div>
        <strong>${ingresoCodigo}</strong> – ${sec.ingreso.nombre}
      </div>
      <div>
        Inicial: <input type="number" step="0.01" data-tipo="ingreso-inicial" data-ingreso="${ingresoCodigo}" value="${data.inicial}">
        Presupuestado: <input type="number" step="0.01" data-tipo="ingreso-presupuestado" data-ingreso="${ingresoCodigo}" value="${data.presupuestado}">
      </div>
    `;
    div.appendChild(header);

    const tabla = document.createElement("table");
    const thead = document.createElement("thead");
    thead.innerHTML = `
      <tr>
        <th>Código</th>
        <th>Concepto</th>
        <th>Cantidad gasto</th>
        <th>% sobre ingreso</th>
      </tr>
    `;
    tabla.appendChild(thead);

    const tbody = document.createElement("tbody");

    sec.gastos.forEach(g => {
      const gData = data.gastos[g.codigo];
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${g.codigo}</td>
        <td>${g.nombre}</td>
        <td>
          <input type="number" step="0.01"
                 data-tipo="gasto-cantidad"
                 data-ingreso="${ingresoCodigo}"
                 data-gasto="${g.codigo}"
                 value="${gData.cantidad}">
        </td>
        <td>
          <input type="number" step="0.01"
                 data-tipo="gasto-porcentaje"
                 data-ingreso="${ingresoCodigo}"
                 data-gasto="${g.codigo}"
                 value="${gData.porcentaje}">
        </td>
      `;
      tbody.appendChild(tr);
    });

    tabla.appendChild(tbody);
    div.appendChild(tabla);

    const resumen = document.createElement("div");
    resumen.id = `resumen-${ingresoCodigo}`;
    div.appendChild(resumen);

    cont.appendChild(div);
  });

  actualizarModoEntrada();
  recalcularTodo();
  añadirListenersInputs();
}

function actualizarModoEntrada() {
  const modo = document.getElementById("modoEntrada").value;
  const inputsCantidad = document.querySelectorAll('input[data-tipo="gasto-cantidad"]');
  const inputsPorcentaje = document.querySelectorAll('input[data-tipo="gasto-porcentaje"]');

  if (modo === "cantidades") {
    inputsCantidad.forEach(i => i.disabled = false);
    inputsPorcentaje.forEach(i => i.disabled = true);
  } else {
    inputsCantidad.forEach(i => i.disabled = true);
    inputsPorcentaje.forEach(i => i.disabled = false);
  }
}

/* =========================
   5. Lógica de cálculo
   ========================= */

function recalcularTodo() {
  const modo = document.getElementById("modoEntrada").value;

  SECCIONES.forEach(sec => {
    const ingresoCodigo = sec.ingreso.codigo;
    const data = estado[ingresoCodigo];
    const totalIngreso = Number(data.inicial) + Number(data.presupuestado);

    let sumaGastos = 0;
    let sumaPorcentajes = 0;

    if (modo === "cantidades") {
      // A partir de cantidades, calcular %
      for (const g of sec.gastos) {
        const gData = data.gastos[g.codigo];
        const cant = Number(gData.cantidad) || 0;
        sumaGastos += cant;
      }
      for (const g of sec.gastos) {
        const gData = data.gastos[g.codigo];
        const cant = Number(gData.cantidad) || 0;
        gData.porcentaje = totalIngreso > 0 ? (cant / totalIngreso) * 100 : 0;
        const input = document.querySelector(
          `input[data-tipo="gasto-porcentaje"][data-ingreso="${ingresoCodigo}"][data-gasto="${g.codigo}"]`
        );
        if (input) input.value = gData.porcentaje.toFixed(2);
        sumaPorcentajes += gData.porcentaje;
      }
    } else {
      // A partir de %, calcular cantidades
      for (const g of sec.gastos) {
        const gData = data.gastos[g.codigo];
        const pct = Number(gData.porcentaje) || 0;
        sumaPorcentajes += pct;
      }
      for (const g of sec.gastos) {
        const gData = data.gastos[g.codigo];
        const pct = Number(gData.porcentaje) || 0;
        gData.cantidad = (totalIngreso * pct) / 100;
        const input = document.querySelector(
          `input[data-tipo="gasto-cantidad"][data-ingreso="${ingresoCodigo}"][data-gasto="${g.codigo}"]`
        );
        if (input) input.value = gData.cantidad.toFixed(2);
        sumaGastos += gData.cantidad;
      }
    }

    const resumen = document.getElementById(`resumen-${ingresoCodigo}`);
    const dif = Math.abs(sumaGastos - totalIngreso);
    const difPct = Math.abs(sumaPorcentajes - 100);

    let mensajes = [];
    if (totalIngreso === 0 && sumaGastos === 0 && sumaPorcentajes === 0) {
      mensajes.push('<span class="ok">Sin datos todavía.</span>');
    } else {
      if (dif < 0.01) {
        mensajes.push(`<span class="ok">OK: gastos (${sumaGastos.toFixed(2)}) = ingreso (${totalIngreso.toFixed(2)}).</span>`);
      } else {
        mensajes.push(`<span class="error">Error: gastos (${sumaGastos.toFixed(2)}) ≠ ingreso (${totalIngreso.toFixed(2)}).</span>`);
      }
      if (difPct < 0.01) {
        mensajes.push(`<span class="ok">OK: suma de porcentajes = ${sumaPorcentajes.toFixed(2)}%.</span>`);
      } else {
        mensajes.push(`<span class="error">Error: suma de porcentajes = ${sumaPorcentajes.toFixed(2)}% (≠ 100%).</span>`);
      }
    }
    resumen.innerHTML = mensajes.join(" &nbsp; ");
  });

  guardarEstadoIndexedDB(estado);
}

/* =========================
   6. Listeners de inputs
   ========================= */

function añadirListenersInputs() {
  document.querySelectorAll('input[data-tipo="ingreso-inicial"]').forEach(input => {
    input.addEventListener("input", () => {
      const ingreso = input.dataset.ingreso;
      estado[ingreso].inicial = Number(input.value) || 0;
      recalcularTodo();
    });
  });

  document.querySelectorAll('input[data-tipo="ingreso-presupuestado"]').forEach(input => {
    input.addEventListener("input", () => {
      const ingreso = input.dataset.ingreso;
      estado[ingreso].presupuestado = Number(input.value) || 0;
      recalcularTodo();
    });
  });

  document.querySelectorAll('input[data-tipo="gasto-cantidad"]').forEach(input => {
    input.addEventListener("input", () => {
      const ingreso = input.dataset.ingreso;
      const gasto = input.dataset.gasto;
      estado[ingreso].gastos[gasto].cantidad = Number(input.value) || 0;
      recalcularTodo();
    });
  });

  document.querySelectorAll('input[data-tipo="gasto-porcentaje"]').forEach(input => {
    input.addEventListener("input", () => {
      const ingreso = input.dataset.ingreso;
      const gasto = input.dataset.gasto;
      estado[ingreso].gastos[gasto].porcentaje = Number(input.value) || 0;
      recalcularTodo();
    });
  });
}

/* =========================
   7. Exportar / Importar CSV
   ========================= */

function estadoToCSV() {
  const filas = [];
  filas.push([
    "tipo", "codigo_ingreso", "nombre_ingreso",
    "inicial", "presupuestado",
    "codigo_gasto", "nombre_gasto",
    "cantidad_gasto", "porcentaje_gasto"
  ].join(";"));

  SECCIONES.forEach(sec => {
    const ingresoCodigo = sec.ingreso.codigo;
    const data = estado[ingresoCodigo];
    sec.gastos.forEach(g => {
      const gData = data.gastos[g.codigo];
      filas.push([
        "fila",
        ingresoCodigo,
        sec.ingreso.nombre,
        data.inicial,
        data.presupuestado,
        g.codigo,
        g.nombre,
        gData.cantidad,
        gData.porcentaje
      ].join(";"));
    });
  });

  return filas.join("\n");
}

function descargarCSV() {
  const csv = estadoToCSV();
  const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "presupuesto.csv";
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

function importarCSV(texto) {
  const lineas = texto.split(/\r?\n/).filter(l => l.trim().length > 0);
  if (lineas.length <= 1) return;
  for (let i = 1; i < lineas.length; i++) {
    const cols = lineas[i].split(";");
    if (cols.length < 9) continue;
    const tipo = cols[0];
    if (tipo !== "fila") continue;
    const codIngreso = cols[1];
    const inicial = Number(cols[3]) || 0;
    const presupuestado = Number(cols[4]) || 0;
    const codGasto = cols[5];
    const cantGasto = Number(cols[7]) || 0;
    const pctGasto = Number(cols[8]) || 0;

    if (!estado[codIngreso]) continue;
    estado[codIngreso].inicial = inicial;
    estado[codIngreso].presupuestado = presupuestado;
    if (estado[codIngreso].gastos[codGasto]) {
      estado[codIngreso].gastos[codGasto].cantidad = cantGasto;
      estado[codIngreso].gastos[codGasto].porcentaje = pctGasto;
    }
  }
  render();
}

/* =========================
   8. Generación de PDF
   ========================= */

function generarPDF() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();

  let y = 10;
  doc.setFontSize(14);
  doc.text("Presupuesto del centro", 10, y);
  y += 8;
  doc.setFontSize(10);

  SECCIONES.forEach(sec => {
    const ingresoCodigo = sec.ingreso.codigo;
    const data = estado[ingresoCodigo];
    const totalIngreso = Number(data.inicial) + Number(data.presupuestado);

    if (y > 270) { doc.addPage(); y = 10; }

    doc.setFont(undefined, "bold");
    doc.text(`${ingresoCodigo} – ${sec.ingreso.nombre}`, 10, y);
    y += 5;
    doc.setFont(undefined, "normal");
    doc.text(
      `Inicial: ${data.inicial.toFixed(2)}   Presupuestado: ${data.presupuestado.toFixed(2)}   Total: ${totalIngreso.toFixed(2)}`,
      10,
      y
    );
    y += 5;

    sec.gastos.forEach(g => {
      const gData = data.gastos[g.codigo];
      if (y > 280) { doc.addPage(); y = 10; }
      doc.text(
        `${g.codigo}  ${g.nombre}  | Cant: ${gData.cantidad.toFixed(2)}  | %: ${gData.porcentaje.toFixed(2)}`,
        12,
        y
      );
      y += 4;
    });

    y += 4;
  });

  doc.save("presupuesto.pdf");
}

/* =========================
   9. Inicialización
   ========================= */

window.addEventListener("load", async () => {
  await abrirDB();
  const cargado = await cargarEstadoIndexedDB();
  if (cargado) {
    estado = cargado;
  } else {
    estado = crearEstadoInicial();
  }

  document.getElementById("modoEntrada").addEventListener("change", () => {
    actualizarModoEntrada();
    recalcularTodo();
  });

  document.getElementById("btnExportCSV").addEventListener("click", descargarCSV);

  document.getElementById("fileImportCSV").addEventListener("change", (e) => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (ev) => {
      importarCSV(ev.target.result);
      e.target.value = "";
    };
    reader.readAsText(file, "utf-8");
  });

  document.getElementById("btnGenerarPDF").addEventListener("click", generarPDF);

  render();
});
</script>
</body>
</html>

